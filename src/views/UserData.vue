<template>
  <div>
    <el-container>
      <el-header class="user-header">
        <el-row>
          <el-col :span="5">
            <div style="color: white; text-align: right; font-size: 24px">
              ÈöîÊ±üÊòéÊúàÁÖßËé≤Âçé&nbsp;&nbsp;|
            </div>
          </el-col>
          <el-col :span="15">
            <div
              style="
                color: white;
                margin-left: 5px;
                text-align: left;
                font-size: 16px;
              "
            >
              &nbsp;&nbsp;‰∏™‰∫∫‰∏≠ÂøÉ
            </div>
          </el-col>
          <el-col :span="4">
            <div v-if="user.id" class="el-user-welcome">
              <el-avatar :size="35" :src="user.avatar"></el-avatar>
              <div
                :underline="false"
                style="
                  margin-left: 10px;
                  margin-right: 10px;
                  color: white;
                  font-size: 16px;
                  display: -webkit-box;
                  overflow: hidden;
                  -webkit-box-orient: vertical;
                  -webkit-line-clamp: 1;
                "
              >
                {{ user.userName }}
              </div>
              <el-button style="margin-left: 10px" size="mini" @click="logout"
                >ÈÄÄÂá∫</el-button
              >
            </div>
            <div v-else>
              <a href="/login">
                <el-button size="mini" type="primary">ÁôªÂΩï</el-button>
              </a>
              <a href="/register" style="margin-left: 10px">
                <el-button size="mini">Ê≥®ÂÜå</el-button>
              </a>
            </div>
          </el-col>
        </el-row>
      </el-header>
      <el-main class="user-main" v-if="user.id">
        <el-row :gutter="20" style="height: 100%">
          <el-col :span="7" align="center">
            <el-card style="width: 80%; border-radius: 20px; height: 100%">
              <div
                style="text-align: left; margin-top: 20px; font-size: larger"
              >
                ‰∏™‰∫∫‰ø°ÊÅØ
              </div>
              <el-divider></el-divider>

              <el-upload
                class="avatar-uploader"
                action="shuaigang.top"
                :http-request="uploadUserAvatar"
                :show-file-list="false"
                :on-success="handleAvatarSuccess"
                :before-upload="beforeAvatarUpload"
              >
                <img v-if="user.avatar" :src="user.avatar" class="avatar" />
                <img v-else :src="kong" class="avatar" />
              </el-upload>

              <div
                v-if="!updateState"
                style="color: black; font-size: 16px; margin-top: 20px"
              >
                ÁÇπÂáªÂ§¥ÂÉèËøõË°å‰øÆÊîπ
              </div>
              <div v-else align="center" style="margin-top: 20px">
                <el-button size="mini" round @click="cancelUpdateAvatar"
                  >ÂèñÊ∂à</el-button
                >
                <el-button
                  size="mini"
                  round
                  type="primary"
                  @click="confirmUpdate"
                  >Á°ÆÂÆö</el-button
                >
              </div>
              <el-divider style="margin-top: 40px"></el-divider>
            </el-card>
          </el-col>
          <el-col :span="10">
            <el-card style="border-radius: 5px; height: 100%">
              <div
                style="text-align: left; margin-top: 20px; font-size: larger"
              >
                Âü∫Êú¨ËµÑÊñô
              </div>
              <el-divider></el-divider>
              <el-tabs v-model="startName" @tab-click="activeClick">
                <el-tab-pane label="Âü∫Êú¨ËµÑÊñô" name="first">
                  <el-form
                    ref="upadteUserForm"
                    :model="user"
                    :rules="rules"
                    label-width="100px"
                    class="demo-ruleForm"
                  >
                    <el-form-item label="Áî®Êà∑ÂêçÔºö" prop="userName">
                      <el-input v-model="user.userName" />
                    </el-form-item>
                    <el-form-item label="ÁîüÊó•Ôºö" required prop="birthday">
                      <el-date-picker
                        v-model="user.birthday"
                        type="date"
                        placeholder="ËØ∑ÈÄâÊã©ÁîüÊó•"
                        style="width: 100%"
                        :disabled-date="disabledDate"
                        :editable="false"
                      ></el-date-picker>
                    </el-form-item>
                    <el-form-item label="ÁîµËØùÂè∑Á†ÅÔºö" prop="phone">
                      <el-input v-model="user.phone" />
                    </el-form-item>
                    <!-- <el-form-item label="ÈÇÆÁÆ±Ôºö" prop="email">
                      <el-input v-model="user.email" />
                    </el-form-item> -->

                    <el-form-item label="Âú∞ÂùÄÔºö" prop="address" align="left">
                      <el-select v-model="user.address">
                        <el-option
                          v-for="cityData in cityData"
                          :key="cityData.cityName"
                          :label="cityData.cityName"
                          :value="cityData.id"
                        ></el-option>
                      </el-select>
                    </el-form-item>

                    <el-form-item label="ÊÄßÂà´Ôºö" prop="sex" align="left">
                      <el-radio-group v-model="user.sex">
                        <el-radio :label="1">Áî∑</el-radio>
                        <el-radio :label="0">Â•≥</el-radio>
                      </el-radio-group>
                    </el-form-item>
                    <el-form-item align="center">
                      <span class="dialog-footer">
                        <el-button @click="cancelUpdate">ÂèñÊ∂à</el-button>
                        <el-button type="primary" @click="updateUser"
                          >Á°ÆÂÆö</el-button
                        >
                      </span>
                    </el-form-item>
                  </el-form>
                </el-tab-pane>
                <el-tab-pane label="‰øÆÊîπÂØÜÁ†Å" name="second">
                  <el-form
                    ref="passwordForm"
                    :model="user"
                    :rules="rules"
                    label-width="100px"
                    class="demo-ruleForm"
                  >
                    <el-form-item label="ÊóßÂØÜÁ†ÅÔºö" prop="oldPassword">
                      <el-input v-model="user.oldPassword" show-password />
                    </el-form-item>
                    <el-form-item label="Êñ∞ÂØÜÁ†ÅÔºö" prop="newPassword">
                      <el-input v-model="user.newPassword" show-password />
                    </el-form-item>
                    <el-form-item label="Á°ÆËÆ§ÂØÜÁ†ÅÔºö" prop="newPassword2">
                      <el-input v-model="user.newPassword2" show-password />
                    </el-form-item>
                    <el-form-item align="center">
                      <span class="dialog-footer">
                        <el-button @click="cancelUpdatePassword"
                          >ÂèñÊ∂à</el-button
                        >
                        <el-button type="primary" @click="updatePassword"
                          >Á°ÆÂÆö</el-button
                        >
                      </span>
                    </el-form-item>
                  </el-form>
                </el-tab-pane>
              </el-tabs>
            </el-card>
          </el-col>
          <el-col :span="7" align="center">
            <el-card style="width: 80%; height: 100%; border-radius: 20px">
              <div style="color: black; font-size: x-large; margin-top: 60px">
                HiÔºå{{ user.userName }} &nbsp;&nbsp;üéà
              </div>
              <el-divider style="margin-top: 40px"></el-divider>
              <el-row>
                <el-col :span="12">
                  <div style="font-size: large; text-align: left">Â∏ÆÂä©‰∏≠ÂøÉ</div>
                </el-col>
                <el-col :span="12">
                  <div style="font-size: small; text-align: right">
                    <el-link
                      :underline="false"
                      type="primary"
                      style="color: #409eff"
                      disabled
                      >Êõ¥Â§öÔºû</el-link
                    >
                  </div>
                </el-col>
              </el-row>
              <div align="left" style="margin-top: 30px">
                <el-button
                  round
                  style="background-color: #dededa"
                  @click="clickMessage"
                  >Â¶Ç‰ΩïÊ≥®ÈîÄË¥¶Âè∑Ôºü</el-button
                >
              </div>
              <!-- <div align="left" style="margin-top: 15px">
                <el-button round style="background-color: #dededa" @click="clickMessage"
                  >Áî≥ËØâÊú™ÈÄöËøáÊÄé‰πàÂäûÔºü</el-button
                >
              </div> -->
              <div align="left" style="margin-top: 15px">
                <el-button
                  round
                  style="background-color: #dededa"
                  @click="clickMessage"
                  >ÈÅáÂà∞È£éÈô©ÔºåÂ¶Ç‰ΩïÂÜªÁªìÔºü</el-button
                >
              </div>
              <el-divider></el-divider>
              <el-row>
                <el-col :span="12">
                  <div style="font-size: large; text-align: left">ÊÑèËßÅÂèçÈ¶à</div>
                </el-col>
                <el-col :span="12">
                  <div style="font-size: small; text-align: right">
                    <el-link
                      :underline="false"
                      type="primary"
                      style="color: #409eff"
                      disabled
                      >Êõ¥Â§öÔºû</el-link
                    >
                  </div>
                </el-col>
              </el-row>
              <div align="left" style="margin-top: 30px">
                <el-button
                  round
                  style="background-color: #dededa"
                  @click="clickMessage"
                  >ÊÑèËßÅÊàñÂª∫ËÆÆ</el-button
                >
              </div>
              <div align="left" style="margin-top: 15px">
                <el-button
                  round
                  style="background-color: #dededa"
                  @click="clickMessage"
                  >bugÂèçÈ¶à</el-button
                >
              </div>
            </el-card>
          </el-col>
        </el-row>
      </el-main>
      <el-footer class="user-footer">
        <div style="margin-top: 8px">Â∏ÖÂàö¬©2021</div>
        <el-link :underline="false" @click="record2"
          >Ê∏ùICPÂ§á2021011002Âè∑</el-link
        >
      </el-footer>
    </el-container>
  </div>
</template>


<script lang="ts">
import post from "@/http/axios";
import { ElMessage } from "element-plus";
import { Base64 } from "js-base64";
import moment from "moment";
import { defineComponent, onMounted, reactive, ref, toRefs } from "vue";
export default defineComponent({
  components: {},
  props: {},
  setup() {
    const handleOpen = (key, keyPath) => {};
    const handleClose = (key, keyPath) => {};
    // È°µÈù¢Êï∞ÊçÆ
    const state = reactive({
      kong: "https://shuaigang.top/shuaigang/static-resource/formal/2/20211208",
      updateState: false,
      avatarPath: "",
      userfooter: {
        link: "https://beian.miit.gov.cn",
      },
      startName: "first",
      user: {
        id: "",
        address: "",
        avatar: "",
        birthday: "",
        oldPassword: "",
        newPassword: "",
        newPassword2: "",
      },
      cityId: "",
      // userData: {
      //   id: "",
      //   userName: "",
      //   birthday: "",
      //   email: "",
      //   phone: "",
      //   avatar: "",
      //   sex: "",
      //   address: "",
      //   cityName: "",
      // },
      cityData: [
        {
          id: "",
          cityName: "",
        },
      ],
      rules: {
        userName: [
          {
            required: true,
            message: "ËØ∑ËæìÂÖ•Áî®Êà∑Âêç",
            trigger: "blur",
          },
          {
            min: 2,
            max: 8,
            message: "ÈïøÂ∫¶Âú®‰∫åÂà∞ÂÖ´‰Ωç‰πãÈó¥",
            trigger: "blur",
          },
        ],
        oldPassword: [
          {
            required: true,
            message: "Á§∫‰æãÔºöAa123456",
            trigger: "blur",
            transform(value) {
              let regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
              if (regex.test(value)) {
                return value;
              }
            },
          },
          {
            min: 8,
            max: 16,
            message: "ÈïøÂ∫¶Âú®8Âà∞16‰Ωç‰πãÈó¥",
            trigger: "blur",
          },
        ],
        newPassword: [
          {
            required: true,
            message: "Á§∫‰æãÔºöAa123456",
            trigger: "blur",
            transform(value) {
              let regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
              if (regex.test(value)) {
                return value;
              }
            },
          },
          {
            min: 8,
            max: 16,
            message: "ÈïøÂ∫¶Âú®8Âà∞16‰Ωç‰πãÈó¥",
            trigger: "blur",
          },
        ],
        newPassword2: [
          {
            required: true,
            message: "Á§∫‰æãÔºöAa123456",
            trigger: "blur",
            transform(value) {
              let regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
              if (regex.test(value)) {
                return value;
              }
            },
          },
          {
            min: 8,
            max: 16,
            message: "ÈïøÂ∫¶Âú®8Âà∞16‰Ωç‰πãÈó¥",
            trigger: "blur",
          },
        ],
        phone: [
          {
            required: true,
            message: "ÊâãÊú∫Âè∑Ê†ºÂºèÈîôËØØ",
            trigger: "blur",
            type: "number",
            transform(value) {
              let regex = /^1[3|4|5|7|8]\d{9}$/;
              if (regex.test(value)) {
                return Number(value);
              }
            },
          },
        ],
        email: [
          {
            required: true,
            message: "Á§∫‰æãÔºö1491900793@qq.com",
            trigger: "blur",
            transform(value) {
              let regex =
                /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
              if (regex.test(value)) {
                return value;
              }
            },
          },
        ],
        address: [
          {
            required: true,
            message: "ËØ∑ËæìÂÖ•Âú∞ÂùÄ",
            trigger: "blur",
          },
        ],
        birthday: [
          {
            type: "date",
            required: true,
            message: "ËØ∑ËæìÂÖ•ÁîüÊó•",
            trigger: "change",
          },
        ],
        sex: [
          {
            required: true,
            message: "ËØ∑ÈÄâÊã©ÊÄßÂà´",
            trigger: "change",
          },
        ],
      },
    });
    // ÊñπÊ≥ï‰Ωì
    const methods = {
      clickMessage() {
        ElMessage.warning("ÂºÄÂèë‰∏≠~");
      },
      disabledDate(time) {
        return time.getTime() > Date.now();
      },
      activeClick() {},
      // ‰∏ä‰º†ÊàêÂäüÂõûË∞É
      handleAvatarSuccess(res, file) {},
      // ‰∏ä‰º†ÂâçÊ†ºÂºèÂíåÂõæÁâáÂ§ßÂ∞èÈôêÂà∂
      beforeAvatarUpload(file) {
        const type = file.type === "image/jpeg" || "image/jpg" || "image/png";
        const isLt2M = file.size / 1024 / 1024 < 1;
        if (!type) {
          ElMessage.error("ÂõæÁâáÊ†ºÂºè‰∏çÊ≠£Á°Æ!(Âè™ËÉΩÂåÖÂê´jpgÔºåpngÔºåjpeg)");
        }
        if (!isLt2M) {
          ElMessage.error("‰∏ä‰º†ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá 1MB!");
        }
        return type && isLt2M;
      },
      uploadUserAvatar(file) {
        let formData: any = new FormData();
        formData.append("multipartFile", file.file);
        formData.append("userId", state.user.id);
        formData.append("type", 2);
        request.uploadAvatar(formData);
        // console.log(file);
        console.log(file.file);
      },
      // ÂèñÊ∂à‰øÆÊîπÂ§¥ÂÉè
      cancelUpdateAvatar() {
        state.updateState = false;
        request.getList(state.user.id);
      },
      // Á°ÆÂÆö‰øÆÊîπÂ§¥ÂÉè
      confirmUpdate() {
        request.updateAvatar(state.avatarPath);
      },
      // ÂèñÊ∂à‰øÆÊîπÁî®Êà∑
      cancelUpdate() {
        // Âà∑Êñ∞È°µÈù¢ÈáçÁΩÆ‰ø°ÊÅØ
        // window.location.reload();
        request.getList(state.user.id);
      },
      // ‰øÆÊîπÁî®Êà∑
      updateUser() {
        (state.user.birthday = moment(state.user.birthday).format(
          "YYYY-MM-DD"
        )),
          // console.log(state.user);
          request.update();
      },
      // ÂèñÊ∂à‰øÆÊîπÂØÜÁ†Å
      cancelUpdatePassword() {
        // Âà∑Êñ∞È°µÈù¢ÈáçÁΩÆ‰ø°ÊÅØ
        // window.location.reload();
        request.getList(state.user.id);
      },
      // Á°ÆÂÆö‰øÆÊîπÂØÜÁ†Å
      updatePassword() {
        request.checkPwd();
      },
      // È°µËÑöËøûÊé•Êñ∞È°µÈù¢ÊâìÂºÄ
      record2() {
        window.open(state.userfooter.link);
      },
      // ÈÄÄÂá∫ÁôªÂΩïÂπ∂Ê∏ÖÈô§token„ÄÅuserId„ÄÅrole
      logout() {
        request.logout();
        state.user.id = "";
        localStorage.setItem("token", "");
        localStorage.setItem("shuaigangOVO", "");
        localStorage.setItem("shuaigangQWQ", "");
        window.location.reload();
      },
    };
    // È°µÈù¢ÈªòËÆ§ËØ∑Ê±Ç
    onMounted(() => {
      let userId = localStorage.getItem("shuaigangOVO");
      if (userId === "" || userId === null) {
      } else {
        let id = Base64.decode(userId);
        request.getList(id);
      }
    });
    // ËØ∑Ê±Ç
    const request = {
      getList(id) {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {
            userId: id,
          },
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          // console.log(res);
          let { code, message, customData } = res;
          if (code === 200) {
            state.user = customData;
            state.cityId = state.user.address;
            // console.log(state.user.avatar);
            request.getCity();
          } else {
            ElMessage.error(message);
          }
        });
      },
      getCity() {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {},
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          // console.log(res);
          let { code, message, customData } = res;
          if (code === 200) {
            state.cityData = customData;
          } else {
            ElMessage.error(message);
          }
        });
      },
      logout() {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {
            userId: state.user.id,
          },
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          // console.log(res);
          let { code, message, customData } = res;
          if (code === 200) {
            ElMessage.success(message);
          }
        });
      },
      update() {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: state.user,
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          let { code, message, customData } = res;
          if (code === 200) {
            ElMessage.success(message);
            if (state.cityId !== state.user.address) {
              // console.log(state.cityId);
              request.updateCityValue(state.cityId, -1);
              // console.log(state.user.address);
              request.updateCityValue(state.user.address, 2);
            } else {
              request.getList(state.user.id);
            }
          } else {
            ElMessage.error(message);
          }
        });
      },
      updateCityValue(id, subtractOrAdd) {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {
            id,
            subtractOrAdd,
          },
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          let { code, message, customData } = res;
          if (code === 200) {
            request.getList(state.user.id);
          } else {
            return;
          }
        });
      },
      uploadAvatar(formData) {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ

        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", formData).then((res: any) => {
          let { code, message, customData } = res;
          if (code === 200) {
            // console.log(res);
            state.user.avatar = customData.avatarPath;
            state.updateState = true;
            state.avatarPath = customData.avatarPath;
          } else {
            ElMessage.error(message);
          }
        });
      },
      updateAvatar(filePath) {
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {
            id: state.user.id,
            avatar: filePath,
          },
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          let { code, message } = res;
          if (code === 200) {
            request.getList(state.user.id);
            ElMessage.success("‰øÆÊîπÊàêÂäüÔºÅ");
            state.updateState = false;
          } else {
            ElMessage.error(message);
          }
        });
      },
      checkPwd() {
        // Áî®Êà∑ID
        let userId = localStorage.getItem("shuaigangOVO");
        if (userId) {
          state.user.id = Base64.decode(userId);
        }
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {
            id: state.user.id,
            password: state.user.oldPassword,
          },
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          let { code, message, customData } = res;
          if (code === 200) {
            request.updatePwd();
          } else {
            ElMessage.error(message);
          }
        });
      },
      updatePwd() {
        // Áî®Êà∑ID
        let userId = localStorage.getItem("shuaigangOVO");
        if (userId) {
          state.user.id = Base64.decode(userId);
        }
        // ËØ∑Ê±Ç‰ΩìÊï∞ÊçÆ
        const data = {
          customData: {
            id: state.user.id,
            oldPassword: state.user.oldPassword,
            newPassword: state.user.newPassword,
          },
        };
        // postËØ∑Ê±Ç
        post("xx/xx/xx/xx", data).then((res: any) => {
          let { code, message } = res;
          if (code === 200) {
            ElMessage.success(message);
          } else {
            ElMessage.warning(message);
          }
        });
      },
    };
    return {
      ...methods,
      ...toRefs(state),
      handleOpen,
      handleClose,
    };
  },
});
</script>

<style>
.user-header {
  background-color: #b3c0d1;
  color: #333;
  text-align: center;
  line-height: 60px;
}

.el-main::-webkit-scrollbar {
  display: none;
}

.user-main {
  height: calc(100vh - 120px);
  background-color: #ebf7f4;
  color: #333;
  text-align: center;
}

.user-footer {
  background-color: #e8ebee;
  color: #333;
  text-align: center;
  width: 100%;
  bottom: 0;
  position: fixed;
}

.el-user-data {
  width: 100%;
  display: flex;
}

.avatar-uploader {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  background-size: 100% 100%;
}
.avatar-uploader-icon {
  font-size: 0;
  color: #fff;
  width: 120px;
  height: 120px;
  line-height: 120px;
  text-align: center;
}
.avatar {
  position: relative;
  width: 120px;
  height: 120px;
  display: block;
}
.el-user-welcome {
  width: 100%;
  display: flex;
  align-items: center;
}
</style>
